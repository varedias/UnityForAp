# ğŸ¨ KajamansRoads è´´å›¾ä¿®å¤ - å®Œæ•´æŒ‡å—

## ğŸ” é—®é¢˜åˆ†æ

æ‚¨å‘ç°çš„é—®é¢˜ï¼š
- âŒ **Material æ˜¾ç¤ºç´«è‰²** â†’ ç€è‰²å™¨ä¸å…¼å®¹ï¼ˆBuilt-inç€è‰²å™¨åœ¨URPé¡¹ç›®ä¸­ï¼‰
- âœ… **Textures æœ‰çœŸå®è´´å›¾** â†’ é“è·¯çš„å®é™…çº¹ç†å›¾ç‰‡å­˜åœ¨

### åŸå› 

KajamansRoads èµ„æºåŒ…ä½¿ç”¨çš„æ˜¯ **Built-in æ¸²æŸ“ç®¡çº¿**çš„ç€è‰²å™¨ï¼š
- `Standard`
- `Mobile/Diffuse`
- `Legacy Shaders/Diffuse`

ä½†æ‚¨çš„é¡¹ç›®æ˜¯ **URP (Universal Render Pipeline)**ï¼Œä¸¤è€…ä¸å…¼å®¹ï¼

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**ä¿ç•™è´´å›¾ (Textures)** + **æ›¿æ¢ç€è‰²å™¨ (Shader)** = âœ¨ çœŸå®é“è·¯æ•ˆæœ

---

## ğŸš€ å¿«é€Ÿä¿®å¤ - ä¸€é”®æå®š

### æ–¹æ³•1: ä½¿ç”¨è‡ªåŠ¨ä¿®å¤å·¥å…·ï¼ˆæœ€ç®€å•ï¼‰â­â­â­

1. **æ’­æ”¾åœºæ™¯**
   ```
   æŒ‰æ’­æ”¾é”® â–¶
   ç­‰å¾…é“è·¯é¢„åˆ¶ä½“å®ä¾‹åŒ–
   ```

2. **åœæ­¢æ’­æ”¾**
   ```
   æŒ‰åœæ­¢é”® â¹
   ä¿æŒå®ä¾‹åŒ–çš„é“è·¯å¯¹è±¡
   ```

3. **æ‰“å¼€ä¿®å¤å·¥å…·**
   ```
   Unity èœå• > Tools > Star Falling Animation > Fix Purple Materials
   ```

4. **ç‚¹å‡»ä¿®å¤æŒ‰é’®**
   ```
   ç‚¹å‡» "ğŸ›£ï¸ ä¿®å¤ KajamansRoads è´´å›¾"
   ```

5. **å®Œæˆï¼**
   - âœ… æ‰€æœ‰è´´å›¾ä¿ç•™
   - âœ… ç€è‰²å™¨æ›´æ¢ä¸º URP/Lit
   - âœ… é“è·¯æ˜¾ç¤ºçœŸå®çº¹ç†

---

### æ–¹æ³•2: åœ¨è¿è¡Œæ—¶è‡ªåŠ¨ä¿®å¤

å¦‚æœæ‚¨å¸Œæœ›æ¯æ¬¡æ’­æ”¾éƒ½è‡ªåŠ¨ä¿®å¤ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªè„šæœ¬ï¼š

1. **åˆ›å»ºè¿è¡Œæ—¶ä¿®å¤è„šæœ¬**

åœ¨ `RoadManager.cs` çš„ `Start()` æ–¹æ³•åæ·»åŠ ï¼š

```csharp
void Start()
{
    // ç°æœ‰ä»£ç ...
    
    // è‡ªåŠ¨ä¿®å¤æè´¨
    FixRoadMaterialsAtRuntime();
}

private void FixRoadMaterialsAtRuntime()
{
    StartCoroutine(FixMaterialsAfterInstantiation());
}

private IEnumerator FixMaterialsAfterInstantiation()
{
    // ç­‰å¾…ä¸€å¸§ï¼Œç¡®ä¿é¢„åˆ¶ä½“å·²å®ä¾‹åŒ–
    yield return null;
    
    Renderer[] renderers = GetComponentsInChildren<Renderer>();
    int fixedCount = 0;
    
    foreach (Renderer renderer in renderers)
    {
        Material[] materials = renderer.sharedMaterials;
        bool changed = false;
        
        for (int i = 0; i < materials.Length; i++)
        {
            Material mat = materials[i];
            
            if (mat != null && IsShaderInvalid(mat))
            {
                Material newMat = CreateFixedMaterial(mat);
                if (newMat != null)
                {
                    materials[i] = newMat;
                    changed = true;
                    fixedCount++;
                }
            }
        }
        
        if (changed)
        {
            renderer.sharedMaterials = materials;
        }
    }
    
    if (fixedCount > 0)
    {
        Debug.Log($"[RoadManager] è‡ªåŠ¨ä¿®å¤äº† {fixedCount} ä¸ªæè´¨çš„ç€è‰²å™¨");
    }
}

private bool IsShaderInvalid(Material mat)
{
    if (mat.shader == null) return true;
    
    string shaderName = mat.shader.name;
    return shaderName.Contains("Error") || 
           shaderName.Contains("Hidden") ||
           shaderName.Contains("Standard") ||
           shaderName.Contains("Mobile/") ||
           shaderName.Contains("Legacy");
}

private Material CreateFixedMaterial(Material original)
{
    // è·å–åŸå§‹è´´å›¾
    Texture mainTex = original.HasProperty("_MainTex") ? original.GetTexture("_MainTex") : null;
    Color color = original.HasProperty("_Color") ? original.GetColor("_Color") : Color.white;
    
    // åˆ›å»ºURPæè´¨
    Shader urpShader = Shader.Find("Universal Render Pipeline/Lit");
    if (urpShader == null)
    {
        urpShader = Shader.Find("Universal Render Pipeline/Unlit");
    }
    
    if (urpShader != null)
    {
        Material newMat = new Material(urpShader);
        
        if (mainTex != null)
        {
            newMat.SetTexture("_BaseMap", mainTex);
        }
        
        newMat.SetColor("_BaseColor", color);
        newMat.name = original.name + "_URPFixed";
        
        return newMat;
    }
    
    return null;
}
```

---

### æ–¹æ³•3: æ‰‹åŠ¨ä¿®å¤é¢„åˆ¶ä½“æè´¨

å¦‚æœæ‚¨æƒ³æ°¸ä¹…ä¿®å¤ KajamansRoads é¢„åˆ¶ä½“ï¼š

1. **æ‰¾åˆ°é¢„åˆ¶ä½“**
   ```
   Project çª—å£ > Assets/KajamansRoads/Free/Prefabs/
   é€‰æ‹©ä¸€ä¸ªé“è·¯é¢„åˆ¶ä½“
   ```

2. **åœ¨ Inspector ä¸­æŸ¥çœ‹æè´¨**
   ```
   æ‰¾åˆ° Mesh Renderer ç»„ä»¶
   æŸ¥çœ‹ Materials åˆ—è¡¨
   ```

3. **ä¿®å¤æ¯ä¸ªç´«è‰²æè´¨**
   
   å¯¹äºæ¯ä¸ªç´«è‰²æè´¨ï¼š
   
   a. **ç‚¹å‡»æè´¨**
      - åœ¨ Project çª—å£ä¸­å®šä½æè´¨æ–‡ä»¶
   
   b. **æŸ¥çœ‹ Textures**
      - Albedo (Diffuse) è´´å›¾åº”è¯¥å­˜åœ¨
      - è®°ä½è´´å›¾åç§°
   
   c. **æ›´æ¢ Shader**
      - Inspector > Shader ä¸‹æ‹‰èœå•
      - é€‰æ‹© `Universal Render Pipeline > Lit`
   
   d. **é‡æ–°è®¾ç½®è´´å›¾**
      - Base Map: æ‹–å…¥åŸæ¥çš„ Albedo è´´å›¾
      - Base Color: ä¿æŒç™½è‰² (1, 1, 1, 1)
   
   e. **ä¿å­˜**
      - Ctrl + S

4. **åº”ç”¨åˆ°æ‰€æœ‰é¢„åˆ¶ä½“**
   - é‡å¤æ­¥éª¤ 3 for å…¶ä»–é“è·¯é¢„åˆ¶ä½“

---

## ğŸ” éªŒè¯ä¿®å¤æ•ˆæœ

### æ£€æŸ¥æ¸…å•

ä¿®å¤å®Œæˆåï¼Œæ£€æŸ¥ï¼š

- [ ] **Scene çª—å£**: é“è·¯æ˜¾ç¤ºçœŸå®çº¹ç†ï¼ˆæ²¥é’ã€æ ‡çº¿ç­‰ï¼‰
- [ ] **Inspector**: Material ä¸å†æ˜¯ç´«è‰²
- [ ] **Shader**: æ˜¾ç¤º `Universal Render Pipeline/Lit` æˆ– `Unlit`
- [ ] **Base Map**: æ˜¾ç¤ºé“è·¯è´´å›¾ç¼©ç•¥å›¾
- [ ] **Console**: æ— çº¢è‰²é”™è¯¯

### é¢„æœŸæ•ˆæœ

**ä¿®å¤å‰**:
```
Material: RoadMaterial
Shader: Standard (ç´«è‰²ï¼)
Textures: 
  _MainTex: road_diffuse.png âœ… (å­˜åœ¨ä½†ä¸æ˜¾ç¤º)
```

**ä¿®å¤å**:
```
Material: RoadMaterial_URPFixed
Shader: Universal Render Pipeline/Lit âœ…
Base Map: road_diffuse.png âœ… (æ­£ç¡®æ˜¾ç¤º)
```

---

## ğŸ¨ æŠ€æœ¯ç»†èŠ‚

### ç€è‰²å™¨å±æ€§æ˜ å°„

| Built-in (æ—§) | URP (æ–°) | è¯´æ˜ |
|--------------|----------|------|
| `_MainTex` | `_BaseMap` | ä¸»è´´å›¾ï¼ˆæ¼«åå°„ï¼‰ |
| `_Color` | `_BaseColor` | ä¸»é¢œè‰²/ç€è‰² |
| `_BumpMap` | `_BumpMap` | æ³•çº¿è´´å›¾ |
| `_EmissionColor` | `_EmissionColor` | è‡ªå‘å…‰ |
| `_Metallic` | `_Metallic` | é‡‘å±åº¦ |
| `_Glossiness` | `_Smoothness` | å…‰æ»‘åº¦ |

### ä¿®å¤æµç¨‹

```
1. æ£€æµ‹ç´«è‰²æè´¨
   â†“
2. æå– Textures (_MainTex, _BumpMapç­‰)
   â†“
3. æå– Colors (_Colorç­‰)
   â†“
4. åˆ›å»º URP æè´¨ (URP/Lit)
   â†“
5. æ˜ å°„å±æ€§ (_MainTex â†’ _BaseMap)
   â†“
6. åº”ç”¨åˆ° Renderer
   â†“
7. å®Œæˆï¼æ˜¾ç¤ºçœŸå®çº¹ç† âœ…
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¿®å¤åè¿˜æ˜¯ç´«è‰²ï¼Ÿ

**æ£€æŸ¥1**: URPåŒ…æ˜¯å¦å·²å®‰è£…
```
Window > Package Manager
æœç´¢ "Universal RP"
ç¡®ä¿å·²å®‰è£…
```

**æ£€æŸ¥2**: æ¸²æŸ“ç®¡çº¿è®¾ç½®
```
Edit > Project Settings > Graphics
Scriptable Render Pipeline Settings ä¸ä¸ºç©º
```

**æ£€æŸ¥3**: è´´å›¾æ˜¯å¦å­˜åœ¨
```
é€‰ä¸­æè´¨ > Inspector
æŸ¥çœ‹ Base Map æ˜¯å¦æœ‰è´´å›¾
å¦‚æœæ˜¯ "None"ï¼Œæ‰‹åŠ¨æ‹–å…¥è´´å›¾
```

---

### Q2: è´´å›¾ä¸¢å¤±äº†ï¼Ÿ

**åŸå› **: è´´å›¾è·¯å¾„é”™è¯¯æˆ–è¢«åˆ é™¤

**è§£å†³**:
1. åœ¨ Project çª—å£æœç´¢è´´å›¾åç§°
2. æ‰‹åŠ¨æ‹–å…¥åˆ°æè´¨çš„ Base Map å­—æ®µ
3. æˆ–é‡æ–°å¯¼å…¥ KajamansRoads èµ„æºåŒ…

---

### Q3: é“è·¯å¤ªäº®/å¤ªæš—ï¼Ÿ

**è°ƒæ•´ Base Color**:
```
é€‰ä¸­æè´¨
è°ƒæ•´ Base Color çš„äº®åº¦:
- å¤ªäº®: é™ä½ RGB å€¼ (ä¾‹å¦‚: 0.5, 0.5, 0.5)
- å¤ªæš—: æé«˜ RGB å€¼ (ä¾‹å¦‚: 1.5, 1.5, 1.5)
```

---

### Q4: æ€§èƒ½ä¸‹é™ï¼Ÿ

**URP/Lit ç€è‰²å™¨æ¯”è¾ƒé‡**

å¦‚æœéœ€è¦ä¼˜åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ **URP/Unlit**:
```
1. é€‰ä¸­ä¿®å¤åçš„æè´¨
2. Shader > Universal Render Pipeline > Unlit
3. ç¡®ä¿ Base Map å·²è®¾ç½®
```

URP/Unlit æ€§èƒ½æ›´å¥½ï¼Œä½†æ²¡æœ‰å…‰ç…§æ•ˆæœã€‚

---

## ğŸ“Š æ‰¹é‡ä¿®å¤è„šæœ¬ï¼ˆé«˜çº§ï¼‰

å¦‚æœæ‚¨æœ‰å¾ˆå¤š KajamansRoads é¢„åˆ¶ä½“éœ€è¦ä¿®å¤ï¼š

### åˆ›å»ºæ‰¹é‡ä¿®å¤å·¥å…·

```csharp
// Assets/Scripts/Editor/BatchFixKajamansRoads.cs

using UnityEngine;
using UnityEditor;
using System.IO;

public class BatchFixKajamansRoads : EditorWindow
{
    [MenuItem("Tools/Batch Fix KajamansRoads Materials")]
    static void ShowWindow()
    {
        GetWindow<BatchFixKajamansRoads>("æ‰¹é‡ä¿®å¤ KajamansRoads");
    }

    void OnGUI()
    {
        if (GUILayout.Button("ä¿®å¤æ‰€æœ‰ KajamansRoads é¢„åˆ¶ä½“"))
        {
            FixAllKajamansRoadsPrefabs();
        }
    }

    void FixAllKajamansRoadsPrefabs()
    {
        string[] prefabGuids = AssetDatabase.FindAssets("t:Prefab", new[] { "Assets/KajamansRoads" });
        int fixedCount = 0;

        foreach (string guid in prefabGuids)
        {
            string path = AssetDatabase.GUIDToAssetPath(guid);
            GameObject prefab = AssetDatabase.LoadAssetAtPath<GameObject>(path);

            if (prefab != null)
            {
                bool modified = false;
                Renderer[] renderers = prefab.GetComponentsInChildren<Renderer>();

                foreach (Renderer renderer in renderers)
                {
                    Material[] materials = renderer.sharedMaterials;

                    for (int i = 0; i < materials.Length; i++)
                    {
                        Material mat = materials[i];
                        if (NeedsFixing(mat))
                        {
                            materials[i] = FixMaterial(mat);
                            modified = true;
                            fixedCount++;
                        }
                    }

                    if (modified)
                    {
                        renderer.sharedMaterials = materials;
                    }
                }

                if (modified)
                {
                    EditorUtility.SetDirty(prefab);
                    AssetDatabase.SaveAssets();
                    Debug.Log($"ä¿®å¤é¢„åˆ¶ä½“: {path}");
                }
            }
        }

        AssetDatabase.Refresh();
        EditorUtility.DisplayDialog("å®Œæˆ", $"å·²ä¿®å¤ {fixedCount} ä¸ªæè´¨ï¼", "ç¡®å®š");
    }

    bool NeedsFixing(Material mat)
    {
        if (mat == null || mat.shader == null) return true;
        string shader = mat.shader.name;
        return shader.Contains("Standard") || shader.Contains("Mobile") || shader.Contains("Error");
    }

    Material FixMaterial(Material original)
    {
        Shader urpShader = Shader.Find("Universal Render Pipeline/Lit");
        Material newMat = new Material(urpShader);

        // å¤åˆ¶è´´å›¾
        if (original.HasProperty("_MainTex"))
        {
            newMat.SetTexture("_BaseMap", original.GetTexture("_MainTex"));
        }

        // å¤åˆ¶é¢œè‰²
        if (original.HasProperty("_Color"))
        {
            newMat.SetColor("_BaseColor", original.GetColor("_Color"));
        }

        newMat.name = original.name;
        return newMat;
    }
}
```

---

## âœ… å®Œæˆï¼

ä½¿ç”¨ä»¥ä¸Šä»»ä¸€æ–¹æ³•ï¼Œæ‚¨çš„ KajamansRoads é“è·¯æè´¨å°†ï¼š

âœ… **ä¿ç•™çœŸå®è´´å›¾** (Textures)  
âœ… **æ›´æ¢ URP ç€è‰²å™¨** (Shader)  
âœ… **æ˜¾ç¤ºæ­£ç¡®æ•ˆæœ** (ä¸å†ç´«è‰²)  
âœ… **æ€§èƒ½ä¼˜åŒ–** (URP æ¸²æŸ“)

**æ¨èæµç¨‹**:
1. ä½¿ç”¨ `ğŸ›£ï¸ ä¿®å¤ KajamansRoads è´´å›¾` å·¥å…·å¿«é€Ÿä¿®å¤
2. å¦‚æœéœ€è¦æ°¸ä¹…ä¿®å¤ï¼Œä½¿ç”¨æ‰¹é‡ä¿®å¤è„šæœ¬
3. è°ƒæ•´ Base Color ä»¥è¾¾åˆ°æœ€ä½³è§†è§‰æ•ˆæœ

ğŸ‰ ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼
